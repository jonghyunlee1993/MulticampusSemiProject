rm(list = ls())

setwd("~/GitRepo/Multicampus_semi/address")

data = read.csv("distance_matrix.csv")
data = data[-1]

header_data = read.csv("집계코드_위도_경도_주소.csv", fileEncoding = "CP949", encoding = "euc-kr")
options("scipen" = 100)
header = header_data[,2]
head(header_data)

department = read.csv("점포이름_위도_경도_주소.csv", fileEncoding = "CP949", encoding = "euc-kr")
head(department)

my_mat = NULL

for (dept in 1:length(data)){
  dat = data[,dept]
<<<<<<< HEAD
  dat[dat == 0] = NA
  
  idx = order(dat)
  
  my_mat = cbind(my_mat, head(header[idx]), head(sort(dat)))
}

=======
  # dat[dat == 0] = NA
  
  idx = order(dat)

  my_mat = cbind(my_mat, head(header[idx]), head(sort(dat), 20))
}

colnames(my_mat) = rep(as.character(department$name), each = 2)
View(my_mat)

write.csv(my_mat, "department_nearest_sector.csv")

>>>>>>> 04c984f6692c6eafda190f1501963ce2f94ad9da
library(rgdal)
library(ggplot2)

my_spdf <- readOGR( 
  dsn= paste0("../map/") , 
  layer="seoul"
)

# 한국 중부 좌표계
from_crs = CRS("+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.996 +x_0=1000000 +y_0=2000000 +ellps=GRS80 +units=m")
# 세계 표준 좌표계
to_crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")

proj4string(my_spdf) = from_crs

converted = spTransform(my_spdf, to_crs)
# converted

plot(converted, axes = T)

# target = header_data[header_data[,2] == my_mat[1,1], 2]
# my_coord = my_spdf[,as.integer(my_spdf@data[, "TOT_REG_CD"]) == my_mat[1,1]]

library(dplyr)
for (i in department$name) {
  if (substr(i, 1, 2) == "신세") {
    
  }
}

department$str_comp = substr(department$name, 1, 2)
department$str_comp = as.factor(department$str_comp)
department = department %>% mutate(comp = ifelse(substr(name, 1, 2) == "신세", 1, 
                                    ifelse(substr(name, 1, 2) == "현대", 2, 3)))

library(rgdal)

# Plot it
fig = ggplot() +
  geom_polygon(data = my_spdf, aes( x = long, y = lat, group = group), fill="#69b3a2", color="white") +
  theme_void() + geom_point(aes(x,y))

fig 

ggplot() +
  geom_polygon(data = converted, aes( x = long, y = lat, group = group), fill="#69b3a2", color="white") +
  theme_gray(base_family='AppleMyungjo') +
  geom_point(data = department, aes(lon, lat, colour = str_comp)) +
  ggtitle("서울시 집계구 경계 및 백화점 위치")

  # theme_void() + geom_point(data = department, aes(lon, lat, colour = factor(comp)))

  # theme_void() + geom_point(data = department, aes(lon, lat, colour = str_comp))


# depart = department[1,]
# 
# ggplot() +
#   geom_polygon(data = temp, aes( x = long, y = lat, group = group), fill="#69b3a2", color="white") +
#   geom_point(data = depart, aes(x = lon, y = lat))
# 
# 
# ggplot()+
#   geom_point(data = department, aes(lon, lat))

<<<<<<< HEAD
=======
# data_result = converted@data
# library(broom)
# shp_result = tidy(converted)
# 
# Name = cbind(id = 1:19153, data_result)
# length(unique(shp_result$order))

suppressPackageStartupMessages({
  library(ggplot2)
  library(ggthemes)
  library(extrafont)
})

library(broom)
temp = tidy(converted)
cname = aggregate(cbind(long, lat) ~ id, data = temp, FUN = mean)



font_import()
theme_set(theme_gray(base_family='AppleMyungjo'))

for (depart in 1:nrow(department)){
  target = header_data[header_data[,2] %in% my_mat[, (depart * 2 - 1)], 2]
  # target_coord = my_spdf[as.integer(my_spdf@data[, "TOT_REG_CD"]) == target, ]
  # plot(target_coord)
  
  target_coord = subset(converted, TOT_REG_CD %in% target)
  target_df = broom::tidy(target_coord)
  cname = aggregate(cbind(long, lat) ~ id, data = target_df, FUN = mean)
  label_data = cbind(cname, target_coord@data)
  
  my_plot = ggplot() +
    geom_polygon(data = target_coord, aes( x = long, y = lat, group = group), fill="#69b3a2", color="white") +
    theme_gray(base_family='AppleMyungjo') + 
    geom_point(data = department[depart,], aes(lon, lat)) +
    geom_text(data = label_data, aes(x = long, y = lat, label = TOT_REG_CD), 
              check_overlap = F, angle = 45) +
    ggtitle(department$name[depart])
  
  print(my_plot)
  
  invisible(readline(prompt="Press [enter] to continue"))
}

